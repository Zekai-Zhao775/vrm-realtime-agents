flowchart TB
    %% System starts with greetAgent as root
    Start([User Connects]) --> Root[greetAgent - Root Agent]
    
    %% greetAgent tools and handoff logic
    Root -->|Tools:<br/>- fetchUserProfile<br/>- fetchHistoryContext<br/>- updateUserProfile| Welcome[Welcome & Consent Process]
    
    %% Handoff configuration from code
    Welcome --> Handoff{greetAgent handoffs to:}
    Handoff -->|User chooses CBT| CBT[cbtTherapistAgent]
    Handoff -->|User chooses Humanistic| Humanistic[humanisticTherapistAgent] 
    Handoff -->|Crisis detected| Safety[safetyAgent]
    
    %% cbtTherapistAgent flow
    CBT -->|Tools:<br/>- fetchUserProfile<br/>- fetchHistoryContext| CBTSession[CBT Therapeutic Work]
    CBTSession -->|Crisis detected| CBTToSafety[Handoff to safetyAgent]
    CBTSession -->|Session ending| CBTEnd[Session End Detection]
    CBTSession -->|Continue| CBTSession
    
    CBTEnd -->|Tools:<br/>- updateProgress<br/>- updateMemory| CBTComplete[CBT Session Complete]
    
    %% humanisticTherapistAgent flow  
    Humanistic -->|Tools:<br/>- fetchUserProfile<br/>- fetchHistoryContext| HumanisticSession[Humanistic Therapeutic Work]
    HumanisticSession -->|Crisis detected| HumanisticToSafety[Handoff to safetyAgent]
    HumanisticSession -->|Session ending| HumanisticEnd[Session End Detection]
    HumanisticSession -->|Continue| HumanisticSession
    
    HumanisticEnd -->|Tools:<br/>- updateProgress<br/>- updateMemory| HumanisticComplete[Humanistic Session Complete]
    
    %% safetyAgent flow
    CBTToSafety --> Safety
    HumanisticToSafety --> Safety
    Safety -->|Tools:<br/>- fetchUserProfile<br/>- fetchHistoryContext| SafetyWork[Crisis Assessment & Support]
    SafetyWork -->|Tools:<br/>- updateProgress<br/>- updateMemory| SafetyComplete[Safety Intervention Complete]
    
    %% All agents can only handoff to safetyAgent (per handoff config)
    CBTComplete --> SessionEnd[Session Complete]
    HumanisticComplete --> SessionEnd
    SafetyComplete --> SessionEnd
    
    SessionEnd --> Disconnect([User Disconnects])
    
    %% Show handoff configuration from index.ts
    subgraph "Handoff Configuration"
        HandoffConfig["greetAgent.handoffs = [cbtTherapistAgent, humanisticTherapistAgent, safetyAgent]<br/>cbtTherapistAgent.handoffs = [safetyAgent]<br/>humanisticTherapistAgent.handoffs = [safetyAgent]<br/>safetyAgent.handoffs = []"]
    end
    
    %% Show tools per agent
    subgraph "Agent Tools"
        GreetTools["greetAgent:<br/>- fetchUserProfile<br/>- updateUserProfile<br/>- fetchHistoryContext"]
        CBTTools["cbtTherapistAgent:<br/>- fetchUserProfile<br/>- updateProgress<br/>- updateMemory<br/>- fetchHistoryContext"]
        HumanTools["humanisticTherapistAgent:<br/>- fetchUserProfile<br/>- updateProgress<br/>- updateMemory<br/>- fetchHistoryContext"]
        SafetyTools["safetyAgent:<br/>- fetchUserProfile<br/>- updateProgress<br/>- updateMemory<br/>- fetchHistoryContext"]
    end
    
    %% Styling
    style Root fill:#e1f5fe,stroke:#01579b,stroke-width:3px
    style CBT fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    style Humanistic fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    style Safety fill:#ffebee,stroke:#b71c1c,stroke-width:2px
    style HandoffConfig fill:#fff3e0
    style GreetTools fill:#e1f5fe
    style CBTTools fill:#f3e5f5
    style HumanTools fill:#e8f5e8
    style SafetyTools fill:#ffebee
    
    style GreetAgent fill:#e1f5fe
    style CBTAgent fill:#f3e5f5
    style HumanAgent fill:#e8f5e8
    style SafetyAgent fill:#ffebee
    style SafetyScreen fill:#fff3e0
    style CrisisCheck fill:#fff3e0
    style EmergencyProtocol fill:#ffcdd2